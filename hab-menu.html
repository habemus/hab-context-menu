<link
  rel="import"
  href="../polymer/polymer.html">

<dom-module id="hab-menu">

  <template>

    <style>
      :host {
        /* ensure fixed position so that the menu may be placed anywhere */
        position: fixed;
      }

      /**
       * copied from
       * http://codepen.io/sstephenson/pen/zepwD
       */
      menu {
        display: block;

        margin: 0;
        padding: 3px 0 4px;

        /*background: rgba(255, 255, 255, 0.95);*/
        background-color: white;
        /*box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.35);*/
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 2px;

        /*font-family: Lucida Grande;*/
        /*font-size: 14px;*/
        /*line-height: 15px;*/
      }

      menu:before {
        display: block;
        position: absolute;
        content: "";
        top: -1px;
        left: -1px;
        bottom: -1px;
        right: -1px;

        border-radius: 2px;
        /*border: 1px solid rgba(0, 0, 0, 0.125);*/
        z-index: -1;
      }

      menu hr {
        border: none;
        height: 1px;
        background: rgba(0, 0, 0, 0.10);
        margin: 6px 1px 5px;
        padding: 0;
      }

      menu menuitem, menu li {
        display: block;

        height: 22px;

        padding: 0 20px;
        border-top: 1px solid rgba(0, 0, 0, 0);
        border-bottom: 1px solid rgba(0, 0, 0, 0);

        white-space: nowrap;
      }

      menu menuitem:after, menu li:after {
        vertical-align: 2px;
        content: attr(label);
      }

      menu menuitem:hover, menu li:hover {
        /*background: -webkit-linear-gradient(top, #648bf5, #2866f2);*/
        /*background: linear-gradient(to bottom, #648bf5 0%, #2866f2 100%);*/
        background-color: #bbb;
        /*border-top: 1px solid #5a82eb;*/
        /*border-bottom: 1px solid #1758e7;*/
      }

      menu menuitem:hover:after, menu li:hover:after {
        color: #fff;
      }
      /**
       * copied from
       * http://codepen.io/sstephenson/pen/zepwD
       */
      
      /**
       * File
       */
      .file-container {
        position: relative;
        height: 22px;
      }

      .file-container menuitem {
        position: absolute;
        z-index: 2;

        width: 100%;
        top: 0;
        left: 0;

        pointer-events: none;
      }

      .file-container input[type="file"] {
        position: absolute;
        z-index: 1;

        width: 100%;
        top: 0;
        left: 0;

        opacity: 0;
      }
      
      /**
       * Submenus
       */
      .submenu-container {
        position: relative;
      }

      .submenu-container > .submenu {
        display: none;
        position: absolute;
        left: 100%;
        top: 0;
      }

      .submenu-container:hover > .submenu {
        display: block;
      }

    </style>

    <menu id="menu">
      <template is="dom-repeat" items="{{ options }}">
        <!-- default -->
        <template is="dom-if" if="[[ !item.type ]]">
          <menuitem
            hidden$="{{ _computeItemValue('hide', context, item) }}"
            on-tap="_handleMenuitemTap"
            label$="{{ _computeItemValue('label', context, item) }}">
          </menuitem>
        </template>

        <!-- url -->
        <template is="dom-if" if="[[ _itemIs(item, 'url') ]]">
          <li
            hidden$="{{ _computeItemValue('hide', context, item) }}">
            <a
              on-tap="_handleMenuitemTap"
              target="{{ _computeItemValue('target', context, item) }}"
              href="{{ _computeItemValue('url', context, item) }}">
              {{ _computeItemValue('label', context, item) }}
            </a>
          </li>
        </template>

        <!-- input:file -->
        <template is="dom-if" if="[[ _itemIs(item, 'input:file') ]]">
          <li
            class="file-container"
            hidden$="{{ _computeItemValue('hide', context, item) }}">
            <menuitem
              hidden$="{{ _computeItemValue('hide', context, item) }}"
              label$="{{ _computeItemValue('label', context, item) }}">
            </menuitem>
            <input on-change="_handleFileInputChange" type="file" multiple>
          </li>
        </template>

        <!-- input:directory -->
        <template is="dom-if" if="[[ _itemIs(item, 'input:directory') ]]">
          <li
            class="file-container"
            hidden$="{{ _computeItemValue('hide', context, item) }}">
            <menuitem
              hidden$="{{ _computeItemValue('hide', context, item) }}"
              label$="{{ _computeItemValue('label', context, item) }}">
            </menuitem>
            <input
              on-change="_handleFileInputChange"
              type="file"
              webkitdirectory mozdirectory msdirectory odirectory directory>
          </li>
        </template>

        <!-- submenu -->
        <template is="dom-if" if="[[ _itemIs(item, 'submenu') ]]">
          <li
            class="submenu-container"
            hidden$="{{ _computeItemValue('hide', context, item) }}">
            {{ _computeItemValue('label', context, item) }}
            <hab-menu
              class="submenu"
              context="{{ context }}"
              options="{{ item.options }}">
            </hab-menu>
          </li>
        </template>
        
      </template>
    </menu>
  </template>

</dom-module>

<script>

(function() {

  Polymer({

    is: 'hab-menu',

    properties: {
      /**
       * Array of context menu options
       */
      options: {
        type: Array,
        notify: true
      },

      /**
       * Holds data about the context of the menu open
       */
      context: {
        type: Object,
      },
    },

    /**
     * Menu item clicks
     */
    _handleMenuitemTap: function (e) {
      var data = e.model.item;

      if (typeof data.callback === 'function') {
        data.callback({
          menuElement: this,
          menuOption: data,
          context: this.get('context'),
          event: e,
        });
      } else {
        // no callback defined, run the default behaviour of
        // closing the menu in the next tick so that it does
        // not interfere with the default behavior of the elemnt
        // setTimeout(this.menuClose.bind(this), 0);
      }
    },

    /**
     * File input
     */
    _handleFileInputChange: function (e) {
      var data  = e.model.item;
      // make a copy of the files array
      var files = Array.prototype.slice.call(e.target.files, 0);

      if (typeof data.callback === 'function') {
        data.callback({
          menuElement: this,
          menuOption: data,
          context: this.get('context'),
          event: e,

          files: files,
        });
      } else {
        // no callback defined, run the default behaviour of
        // closing the menu in the next tick so that it does
        // not interfere with the default behavior of the elemnt
        // setTimeout(this.menuClose.bind(this), 0);
      }

      // reset the input at the end
      e.target.value = '';
    },

    /**
     * Helper function to check the item type
     */
    _itemIs: function (item, type) {
      return item.type === type;
    },

    _computeItemValue: function (key, context, item) {
      if (!context) {
        return;
      }

      var value = item[key];

      if (typeof value === 'function') {
        value = value({
          menuElement: this,
          menuOption: item,
          context: context,
        });
      }

      return value;
    },

  });

})();

</script>
