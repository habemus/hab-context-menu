<link
  rel="import"
  href="../polymer/polymer.html">

<dom-module id="hab-menu">

  <template>

    <style>
    
      /**
       * Annotation: OSX menu reference
       * http://codepen.io/sstephenson/pen/zepwD
       */
       
      /**
       * @menu-text-color: #3C3C3C;
       * @menu-active-text-color: #F5F5F5;
       * @menu-active-color: #6D6D6D;
       */

      menu {
        font-size: 14px;
        display: block;
        
        font-family: sans-serif;

        margin: 0;
        padding: 4px 0;

        background-color: white;
        /*box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.35);*/
        box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
        border-radius: 2px;
      }

      menu > menuitem,
      menu > .menuitem {
        color: #3C3C3C;
        display: block;
        
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        align-items: center;

        font-size: 14px;
        height: 32px;
        padding-left: 20px;
        padding-right: 20px;
        
        min-width: 100px;

        white-space: nowrap;
        text-decoration: none;
      }

      menu > menuitem:hover,
      menu > .menuitem:hover {
        background-color: #6D6D6D;
        color: #F5F5F5;
        cursor: default;
      }
      
      /**
       * File
       */
      .file-container {
        position: relative;
      }
      
      .file-container label {
        position: relative;
        z-index: 2;
      
        width: 100%;
        top: 0;
        left: 0;
      
        pointer-events: none;
      }
      
      .file-container input[type="file"] {
        position: absolute;
        z-index: 1;
      
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
      
        opacity: 0;
      }
      
      /**
       * Submenus
       */
      .submenu-container {
        position: relative;
      }
      
      .submenu-container > .submenu {
        display: none;
        position: absolute;
        left: 100%;
        top: 0;
      }
      
      .submenu-container:hover > .submenu {
        display: block;
      }

    </style>

    <menu id="menu">
      <template is="dom-repeat" items="{{ options }}">
        <!-- default -->
        <template is="dom-if" if="[[ !item.type ]]">
          <menuitem
            hidden$="{{ _computeItemValue('hide', context, item) }}"
            on-tap="_handleMenuitemTap">
            {{ _computeItemValue('label', context, item) }}
          </menuitem>
        </template>

        <!-- url -->
        <template is="dom-if" if="[[ _itemIs(item, 'url') ]]">
          <a
            class="menuitem"
            hidden$="{{ _computeItemValue('hide', context, item) }}"
            on-tap="_handleMenuitemTap"
            target="{{ _computeItemValue('target', context, item) }}"
            href="{{ _computeItemValue('url', context, item) }}">
            {{ _computeItemValue('label', context, item) }}
          </a>
        </template>

        <!-- input:file -->
        <template is="dom-if" if="[[ _itemIs(item, 'input:file') ]]">
          <menuitem
            class="file-container"
            hidden$="{{ _computeItemValue('hide', context, item) }}">
            <label>
              {{ _computeItemValue('label', context, item) }}
            </label>
            <input on-change="_handleFileInputChange" type="file" multiple>
          </menuitem>
        </template>

        <!-- input:directory -->
        <template is="dom-if" if="[[ _itemIs(item, 'input:directory') ]]">
          <menuitem
            class="file-container"
            hidden$="{{ _computeItemValue('hide', context, item) }}">
            <label>
              {{ _computeItemValue('label', context, item) }}
            </label>
            <input
              on-change="_handleFileInputChange"
              type="file"
              webkitdirectory mozdirectory msdirectory odirectory directory>
          </menuitem>
        </template>

        <!-- submenu -->
        <template is="dom-if" if="[[ _itemIs(item, 'submenu') ]]">
          <menuitem
            class="submenu-container"
            hidden$="{{ _computeItemValue('hide', context, item) }}">
            <label>{{ _computeItemValue('label', context, item) }}</label>
            <hab-menu
              class="submenu"
              context="{{ context }}"
              options="{{ item.options }}"
              menu-element="{{ menuElement }}">
            </hab-menu>
          </menuitem>
        </template>
        
      </template>
    </menu>
  </template>

</dom-module>

<script>

(function() {

  Polymer({

    is: 'hab-menu',

    properties: {
      /**
       * Array of context menu options
       */
      options: {
        type: Array,
        notify: true
      },

      /**
       * Holds data about the context of the menu open
       */
      context: {
        type: Object,
      },

      /**
       * The main menuElement
       * 
       * @type {Object}
       */
      menuElement: {
        type: Object,
      }
    },

    /**
     * Menu item clicks
     */
    _handleMenuitemTap: function (e) {
      var data = e.model.item;

      if (typeof data.callback === 'function') {
        data.callback({
          menuElement: this.get('menuElement'),
          menuOption: data,
          context: this.get('context'),
          event: e,
        });
      } else {
        // no callback defined, run the default behaviour of
        // closing the menu in the next tick so that it does
        // not interfere with the default behavior of the elemnt
        // setTimeout(this.menuClose.bind(this), 0);
      }
    },

    /**
     * File input
     */
    _handleFileInputChange: function (e) {
      var data  = e.model.item;
      // make a copy of the files array
      var files = Array.prototype.slice.call(e.target.files, 0);

      if (typeof data.callback === 'function') {
        data.callback({
          menuElement: this.get('menuElement'),
          menuOption: data,
          context: this.get('context'),
          event: e,

          files: files,
        });
      } else {
        // no callback defined, run the default behaviour of
        // closing the menu in the next tick so that it does
        // not interfere with the default behavior of the elemnt
        // setTimeout(this.menuClose.bind(this), 0);
      }

      // reset the input at the end
      e.target.value = '';
    },

    /**
     * Helper function to check the item type
     */
    _itemIs: function (item, type) {
      return item.type === type;
    },

    _computeItemValue: function (key, context, item) {
      if (!context) {
        return;
      }

      var value = item[key];

      if (typeof value === 'function') {
        value = value({
          menuElement: this.get('menuElement'),
          menuOption: item,
          context: context,
        });
      }

      return value;
    },
    
    /**
     * Retrieves the menu offsetHeight
     */
    getOffsetHeight: function () {
      return this.$.menu.offsetHeight;
    },

  });

})();

</script>
